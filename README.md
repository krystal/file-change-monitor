# File Change Monitor

This is a simple tool which can run a command while simultaneously monitoring a list of files for changes. If any of those files change, the running command will be terminated.

## Purpose

The purpose for such a tool is when used within a Kubernetes environment with a mounted Config Map or Secret. Kubernetes can mount a file into a running pod and will keep the contents updated as the configuration is changed which is very handy. However, if the application you're running is not aware of this there is a risk that these changes won't be noticed until they are next restarted.

This tools sole purpose is to keep an eye out for changes and when they occur to kill the process to allow Kubernetes to restart the container and thus have the application pick up the new configuration.

## Use case

We have a number of pods that consume secrets generated by cert manager containing TLS certificates. When these are renewed, it's important that the pods start to use the new cerficiates before the old ones expire. We don't need to restart the pod immediately because the renewal takes place some time before the expiry.

## Why not use X?

There are other tools that are available which can be deployed onto your cluster and will restart pods when secrets or configmaps change. The problem is that if the event is missed or the config watching controller isn't running, it will never be noticed. This might not be a problem for you but, in our case, we need to ensure that config changes are always observed.

The other issue is that we have cause to mount 4-5 certificates into our pods which are all renewed at the same time by Cert Manager. This then triggers multiple restarts at the same time which isn't necessary.

## Usage

There are a couple of ways:

1. Add the binary to your image (if you control the image)
2. Add a config map containing the binary and mount it into the pod.
3. Inject the binary into the running pod using an init container

You should then just wrap your existing command within this one:

```
/file-monitor path/to/file1 path/to/file2 -- /my-app --other-options
```

By default, it will sleep 5 minutes between checking the files (can override with the `--sleep` option). When a file changes, it will send a TERM signal to the process, if that doesn't kill the process in 5 minutes (override with `--kill-after`), it will send a KILL signal.
